<!--
Copyright 2026-present Korea Advanced Institute of Science and Technology (KAIST)

Author: Kyuho Son

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<Window x:Class="IndoorMapTools.View.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:imt="clr-namespace:IndoorMapTools"
        xmlns:view="clr-namespace:IndoorMapTools.View"
        xmlns:model="clr-namespace:IndoorMapTools.Model"
        xmlns:viewModel="clr-namespace:IndoorMapTools.ViewModel"
        xmlns:uc="clr-namespace:IndoorMapTools.View.UserControls"
        xmlns:exm="clr-namespace:IndoorMapTools.MVVMExtensions.Markup"
        xmlns:cvt="clr-namespace:IndoorMapTools.Helper"
        xmlns:dc="clr-namespace:EnhancedCommands.Input.DialogCommands;assembly=EnhancedCommands"
        Title="{DynamicResource strings.AppName}"
        WindowStartupLocation="CenterScreen" MinWidth="1280" MinHeight="720"
        mc:Ignorable="d" d:DesignHeight="720" d:DesignWidth="1280">

    <Grid x:Name="mainGrid" d:DataContext="{d:DesignInstance Type=viewModel:MainWindowVM}"
          Background="{DynamicResource {x:Static SystemColors.MenuBarBrushKey}}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="1*" MaxWidth="300"/>
            <ColumnDefinition Width="4*"/>
        </Grid.ColumnDefinitions>

        <Grid x:Name="systemButtonGrid" Grid.Row="0" Grid.Column="0"
              Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="10*"/>
                <ColumnDefinition Width="1*"/>
                <ColumnDefinition Width="10*"/>
                <ColumnDefinition Width="1*"/>
                <ColumnDefinition Width="10*"/>
                <ColumnDefinition Width="1*"/>
                <ColumnDefinition Width="10*"/>
                <ColumnDefinition Width="1*"/>
                <ColumnDefinition Width="10*"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" IsTabStop="False" Style="{StaticResource SystemButtonStyle}"
                    ToolTip="{DynamicResource strings.NewProject}"
                    Visibility="{Binding Model, Converter={cvt:NonNullToVisibility}}">
                <Image Source="/Resources/new.png" Opacity="0.9"/>
                <Button.Command>
                    <dc:MessageBoxCommand Title="{DynamicResource strings.NewProject}"
                                          Buttons="YesNoCancel" Icon="Warning" DefaultResult="Cancel"
                                          Message="{DynamicResource strings.SaveAndNewProjectWarningMessage}"
                                          NoCommand="{Binding NewProjectCommand}">
                        <dc:MessageBoxCommand.Command>
                            <dc:SaveFileDialogCommand Command="{Binding SaveAndNewProjectCommand}"
                                                      Filter="{DynamicResource strings.SaveProjectFilter}"/>
                        </dc:MessageBoxCommand.Command>
                    </dc:MessageBoxCommand>
                </Button.Command>
            </Button>

            <Button Grid.Column="0" IsTabStop="False" Style="{StaticResource SystemButtonStyle}"
                    ToolTip="{DynamicResource strings.NewProject}"
                    Visibility="{Binding Model, Converter={cvt:NullToVisibility}}"
                    Command="{Binding NewProjectCommand}">
                <Image Source="/Resources/new.png" Opacity="0.9"/>
            </Button>
            
            <Button Grid.Column="2" IsTabStop="False" Style="{StaticResource SystemButtonStyle}"
                    ToolTip="{DynamicResource strings.LoadProject}">
                <Button.Command>
                    <dc:OpenFileDialogCommand Title="{DynamicResource strings.LoadProject}" 
                                              Command="{Binding LoadProjectCommand}"
                                              CommandParameter="{Binding FileName, RelativeSource={RelativeSource Self}}"
                                              Filter="{DynamicResource strings.LoadProjectFilter}"/>
                </Button.Command>
                <Image Source="/Resources/load.png" Opacity="0.9"/>
            </Button>

            <Button Grid.Column="4" IsTabStop="False" Style="{StaticResource SystemButtonStyle}"
                    ToolTip="{DynamicResource strings.SaveProject}"
                    IsEnabled="{Binding Model, Converter={cvt:IsNotNull}}">
                <Button.Command>
                    <dc:SaveFileDialogCommand Title="{DynamicResource strings.SaveProject}"
                                              Command="{Binding SaveProjectCommand}" 
                                              CommandParameter="{Binding FileName, RelativeSource={RelativeSource Self}}"
                                              Filter="{DynamicResource strings.SaveProjectFilter}"/>
                </Button.Command>
                <Image Source="/Resources/save.png" Opacity="0.9"/>
            </Button>


            <Button Grid.Column="6" IsTabStop="False" Style="{StaticResource SystemButtonStyle}"
                    ToolTip="{DynamicResource strings.AnalyzeReachability}"
                    IsEnabled="{Binding Model, Converter={cvt:IsNotNull}}">
                <Button.Command>
                    <dc:TemplatedDialogCommand Title="{DynamicResource strings.AnalyzeReachability}"
                                               DialogContext="{Binding}"
                                               OnClosedCommand="{Binding Avm.ClearAnalysisResultCommand}">
                        <DataTemplate DataType="{x:Type viewModel:MainWindowVM}">
                            <view:AnalysisForm/>
                        </DataTemplate>
                    </dc:TemplatedDialogCommand>
                </Button.Command>
                <Image Source="/Resources/analysis.png" Opacity="0.9"/>
            </Button>

            <Button Grid.Column="8" IsTabStop="False" Style="{StaticResource SystemButtonStyle}"
                    IsEnabled="{Binding Model, Converter={cvt:IsNotNull}}"
                    ToolTip="{DynamicResource strings.ExportProject}">
                <Button.Command>
                    <dc:TemplatedConfirmDialogCommand Title="{DynamicResource strings.ExportProject}"
                                               OnOpeningCommand="{Binding Evm.InitDialogStateCommand}"
                                               DialogContext="{Binding Evm}">
                        <dc:TemplatedConfirmDialogCommand.OKCommand>
                            <dc:SaveFileDialogCommand Command="{Binding Evm.ExportProjectCommand}"
                                  CommandParameter="{Binding FileName, RelativeSource={RelativeSource Self}}"
                                  Filter="{DynamicResource strings.ExportProjectFilter}"/>
                        </dc:TemplatedConfirmDialogCommand.OKCommand>
                        <DataTemplate DataType="{x:Type viewModel:ExportProjectVM}">
                            <view:ExportProjectForm/>
                        </DataTemplate>
                    </dc:TemplatedConfirmDialogCommand>
                </Button.Command>
                <Image Source="/Resources/export.png" Opacity="0.9"/>
            </Button>
        </Grid>

        <uc:ListViewEx x:Name="floorList" Grid.Row="1" Margin="5,0,0,5" AlternationCount="99999999"
                       ItemsSource="{Binding Model.Building.Floors}" 
                       SelectedItem="{Binding SelectedFloor, Mode=TwoWay}"
                       IsEnabled="{Binding Model, Converter={cvt:IsNotNull}}"
                       OnFileDropCommand="{Binding CreateFloorCommand}"
                       ScrollViewer.HorizontalScrollBarVisibility="Disabled">
            <uc:ListViewEx.Style>
                <Style TargetType="{x:Type uc:ListViewEx}">
                    <Style.Triggers>
                        <Trigger Property="DataContext" Value="{x:Null}">
                            <Setter Property="IsEnabled" Value="False"/>
                            <Setter Property="Background" Value="LightGray"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </uc:ListViewEx.Style>
            <uc:ListViewEx.Header>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Grid.ColumnSpan="2"
                               HorizontalAlignment="Center" VerticalAlignment="Center" 
                               Text="{DynamicResource strings.FloorsList}"/>
                    <CheckBox x:Name="chkboxMaster" Grid.Column="0" VerticalAlignment="Center"
                              Style="{StaticResource VisibilityCheckBoxStyle}" 
                              IsChecked="{Binding FloorsVisible}"/>
                </Grid>
            </uc:ListViewEx.Header>

            <uc:ListViewEx.ItemTemplate>
                <DataTemplate DataType="{x:Type model:Floor}">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                        <CheckBox x:Name="ddsaw" VerticalAlignment="Center" Style="{StaticResource VisibilityCheckBoxStyle}"
                                  Tag="{exm:DictGetValue Key={Binding}, Map={Binding DataContext.Gvm.FloorStates, ElementName=floorList}}"
                                  IsChecked="{Binding Tag.Visible, RelativeSource={RelativeSource Self}}"/>
                        <TextBlock Text="{Binding Name}" Margin="10,0,0,0"/>
                    </StackPanel>
                </DataTemplate>
            </uc:ListViewEx.ItemTemplate>

            <uc:ListViewEx.ItemContainerStyle>
                <Style TargetType="uc:EnhancedListViewItem">
                    <Style.Resources>
                        <uc:BindingProxy x:Key="dcproxy" Data="{Binding DataContext.Fvm, Source={x:Reference floorList}}"/>
                    </Style.Resources>
                    <Setter Property="Tag" Value="{Binding DataContext.Fvm, ElementName=floorList}"/>
                    <Setter Property="DeleteCommand" Value="{Binding DeleteCommand}"/>
                    <Setter Property="ReorderCommand" Value="{Binding Data.ReorderFloorCommand, Source={StaticResource dcproxy}}"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <MenuItem Header="{DynamicResource strings.ReplicateFloor}">
                                    <MenuItem.Command>
                                        <dc:TemplatedConfirmDialogCommand Title="{DynamicResource strings.ReplicateFloor}"
                                                DialogContext="{Binding Data, Source={StaticResource dcproxy}}"
                                                OKCommand="{Binding Data.ReplicateFloorCommand, Source={StaticResource dcproxy}}"
                                                OnOpeningCommand="{Binding Data.InitDialogStateCommand, Source={StaticResource dcproxy}}"
                                                OnOpeningCommandParameter="{Binding}">
                                            <DataTemplate DataType="{x:Type viewModel:FloorListItemVM}">
                                                <StackPanel Orientation="Horizontal" Margin="10">
                                                    <TextBlock Text="{DynamicResource strings.ReplicateFloorMessagePrefix}"/>
                                                    <uc:EditableText Value="{Binding ReplicationCount}" Validator="Natural"/>
                                                    <TextBlock Text="{DynamicResource strings.ReplicateFloorMessagePostfix}"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </dc:TemplatedConfirmDialogCommand>
                                    </MenuItem.Command>
                                </MenuItem>
                                <MenuItem Header="{DynamicResource strings.PadCropMapImage}">
                                    <MenuItem.Command>
                                        <dc:TemplatedConfirmDialogCommand Title="{DynamicResource strings.PadCropMapImage}"
                                                DialogContext="{Binding Data, Source={StaticResource dcproxy}}"
                                                OnOpeningCommand="{Binding Data.InitDialogStateCommand, Source={StaticResource dcproxy}}"
                                                OKCommand="{Binding Data.PadCropMapImageCommand, Source={StaticResource dcproxy}}"
                                                OnOpeningCommandParameter="{Binding}">
                                            <DataTemplate DataType="{x:Type viewModel:FloorListItemVM}">
                                                <view:PadCropForm/>
                                            </DataTemplate>
                                        </dc:TemplatedConfirmDialogCommand>
                                    </MenuItem.Command>
                                </MenuItem>
                                <MenuItem Header="{DynamicResource strings.ReplaceMapImage}">
                                    <MenuItem.Command>
                                        <dc:TemplatedConfirmDialogCommand Title="{DynamicResource strings.ReplaceMapImage}"
                                                DialogContext="{Binding Data, Source={StaticResource dcproxy}}"
                                                OKCommand="{Binding Data.ReplaceMapImageCommand, Source={StaticResource dcproxy}}"
                                                OnOpeningCommand="{Binding Data.InitDialogStateCommand, Source={StaticResource dcproxy}}"
                                                OnOpeningCommandParameter="{Binding}">
                                            <DataTemplate DataType="{x:Type viewModel:FloorListItemVM}">
                                                <Grid Margin="10" uc:FileDropBehavior.FileDropCommand="{Binding LoadReplacementImageCommand}">
                                                    <Viewbox MinHeight="250" MinWidth="400" MaxHeight="500" MaxWidth="800"
                                                         HorizontalAlignment="Center" VerticalAlignment="Center">
                                                        <Grid Background="White">
                                                            <Image Source="{Binding Model.MapImage}"/>
                                                            <Image Source="{Binding ReplacementImage}"/>
                                                        </Grid>
                                                    </Viewbox>
                                                    <StackPanel Orientation="Vertical" IsEnabled="False" IsHitTestVisible="False"
                                                                VerticalAlignment="Center" HorizontalAlignment="Center">
                                                        <StackPanel.Effect>
                                                            <DropShadowEffect ShadowDepth="0" Color="White" BlurRadius="5"/>
                                                        </StackPanel.Effect>
                                                        <TextBlock TextAlignment="Center" Text="{DynamicResource strings.AlternateImageDescLine1}"/>
                                                        <TextBlock TextAlignment="Center" Text="{DynamicResource strings.AlternateImageDescLine2}"/>
                                                    </StackPanel>
                                                </Grid>
                                            </DataTemplate>
                                        </dc:TemplatedConfirmDialogCommand>
                                    </MenuItem.Command>
                                </MenuItem>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </uc:ListViewEx.ItemContainerStyle>
            <uc:ListViewEx.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="{DynamicResource strings.BatchRenameFloors}" 
                              Command="{Binding BatchFloorNameCommand}"/>
                </ContextMenu>
            </uc:ListViewEx.ContextMenu>
        </uc:ListViewEx>

        <TabControl Grid.Row="0" Grid.RowSpan="2" Grid.Column="1" Margin="5"
                    IsEnabled="{Binding Model, Converter={cvt:IsNotNull}}">
            <TabItem Header="{DynamicResource strings.GlobalMapInfo}">
                <view:GlobalMapUI DataContext="{Binding Gvm}"/>
            </TabItem>
            <TabItem Header="{DynamicResource strings.IndoorMapInfo}">
                <view:IndoorMapUI DataContext="{Binding Ivm}"/>
            </TabItem>
        </TabControl>

        <Border Grid.Row="2" Grid.ColumnSpan="2"/>
        <StatusBar Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="5,0,5,5">
            <StatusBar.ItemsPanel>
                <ItemsPanelTemplate>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1*" MaxWidth="300"/>
                            <ColumnDefinition Width="4*"/>
                        </Grid.ColumnDefinitions>
                    </Grid>
                </ItemsPanelTemplate>
            </StatusBar.ItemsPanel>

            <StatusBarItem Grid.Column="0" HorizontalAlignment="Right" Margin="0,-2,0,-2">
                <Grid HorizontalAlignment="Left">
                    <ProgressBar x:Name="progBar" Value="{Binding ProgressPercentage, Mode=OneWay}" 
                                 Width="100" Height="20" Minimum="0" Maximum="100"
                                 IsIndeterminate="{Binding ProgressIndeterminated}"/>

                    <TextBlock Text="{Binding ProgressPercentage, StringFormat=\{0:D\} \%}"
                               HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsBusy}" Value="False">
                                        <Setter Property="Visibility" Value="Hidden"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ProgressIndeterminated}" Value="True">
                                        <Setter Property="Visibility" Value="Hidden"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </StatusBarItem>
            
            <StatusBarItem Grid.Column="1" HorizontalAlignment="Left" Margin="0,-2,-2,-2">
                <TextBlock x:Name="textBlockStatus" Text="{Binding TaskName}"
                           Visibility="{Binding IsBusy, Converter={cvt:BoolToVisibility}}"/>
            </StatusBarItem>

            <StatusBarItem Grid.Column="1" HorizontalAlignment="Right" Height="24">
                <StackPanel Orientation="Horizontal">
                    <Image Source="pack://application:,,,/Resources/globe.png" 
                           Height="24" Margin="0,-4,0,-4"/>
                    <ComboBox Height="24" Margin="5,-4,10,-4" VerticalContentAlignment="Center"
                              ItemsSource="{Binding AvailableCultures}"
                              SelectedItem="{Binding CurrentCulture}"
                              DisplayMemberPath="NativeName"/>
                    <TextBlock Text="ver " VerticalAlignment="Center"/>
                    <TextBlock Text="{StaticResource AppVersion}" VerticalAlignment="Center"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>

        <Border Grid.Row="0" Grid.Column="0" Grid.RowSpan="2" Grid.ColumnSpan="2"
                Margin="0,0,0,2" Background="White" Opacity="0.5" Cursor="Wait"
                IsHitTestVisible="{Binding IsBusy}" d:Visibility="Hidden" 
                Visibility="{Binding IsBusy, Converter={cvt:BoolToVisibility}}"/>
    </Grid>
</Window>
